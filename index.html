<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patologo Virtuale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .topic-checkbox:checked + label {
            background-color: #4F46E5;
            color: white;
            border-color: #4F46E5;
        }
        .option-radio:checked + label {
            background-color: #374151;
            border-color: #4F46E5;
            box-shadow: 0 0 0 2px #4F46E5;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Patologo Virtuale</h1>
            <p class="text-lg text-gray-400">Mettiti alla prova con domande generate dai tuoi appunti di anatomia patologica.</p>
        </header>

        <!-- Sezione Selezione Argomenti -->
        <div id="setup-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <div id="progress-container" class="mb-6">
                <h3 class="text-lg font-medium text-gray-300 mb-2">Argomenti Identificati</h3>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 100%;"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-400 mt-1">Analisi dei file completata.</p>
            </div>

            <div id="topic-selection">
                <h3 class="text-lg font-medium text-gray-300 mb-3">Scegli gli argomenti per il quiz:</h3>
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="select-all-topics" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                    <label for="select-all-topics" class="ml-2 block text-sm text-gray-300">Seleziona tutti / Deseleziona tutti</label>
                </div>
                <div id="topics-list" class="flex flex-wrap gap-2"></div>
            </div>
            
            <button id="start-quiz-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-600">
                Avvia il Quiz (45 Domande)
            </button>
        </div>

        <!-- Sezione Quiz -->
        <div id="quiz-section" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span id="question-counter" class="text-sm font-medium text-gray-400">Domanda 1 di 45</span>
                    <button id="finish-quiz-btn" class="bg-red-600 text-white font-bold py-1 px-3 text-sm rounded-lg hover:bg-red-700 transition duration-300">Termina Quiz</button>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="quiz-progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div id="quiz-content" class="mb-6"></div>
            <div class="flex justify-between">
                <button id="prev-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition">Precedente</button>
                <button id="next-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Successivo</button>
            </div>
        </div>

        <!-- Sezione Report -->
        <div id="report-section" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center text-white mb-4">Report del Quiz</h2>
            <div class="text-center mb-6 p-4 bg-gray-700 rounded-lg">
                <p class="text-lg text-gray-300">Punteggio Finale:</p>
                <p id="final-score" class="text-5xl font-extrabold text-indigo-400"></p>
                <p class="text-md text-gray-400">normalizzato in 33esimi</p>
            </div>
            <div id="report-content" class="space-y-4"></div>
            <button id="restart-btn" class="mt-8 w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                Ricomincia
            </button>
        </div>
    </div>

    <script>
        // --- BANCA DATI DELLE DOMANDE ---
        const questionBank = [
            // Domande estratte dai file .txt forniti dall'utente
            { topic: "Metodologia", question: "Quale di questi parametri non è valutabile macroscopicamente?", options: ["Forma", "Dimensioni", "Numero di mitosi", "Consistenza", "Colore"], correctAnswer: 2, explanation: "Il numero di mitosi è un parametro istologico, visibile solo al microscopio, e non può essere valutato macroscopicamente.", isFromFile: true },
            { topic: "Metodologia", question: "La colorazione più comunemente usata per l'osservazione istologica morfologica è l'ematossilina-eosina. Essa si basa:", options: ["Su principi fisici di densità", "Su affinità di tipo acido-base", "Su affinità antigene-anticorpo", "Su legami chimici covalenti", "Su principi non noti"], correctAnswer: 1, explanation: "L'ematossilina è un colorante basico che lega le strutture acide (basofile) come i nuclei (DNA/RNA), colorandole in blu/viola. L'eosina è un colorante acido che lega le strutture basiche (acidofile) come il citoplasma, colorandolo in rosa/rosso.", isFromFile: true },
            { topic: "Danno Cellulare", question: "Per apoptosi si intende?", options: ["La morte cellulare non programmata", "La morte cellulare programmata", "Le modificazioni conseguenti alla morte cellulare non programmata", "L'ischemia", "La morte cellulare in genere"], correctAnswer: 1, explanation: "L'apoptosi è un meccanismo di morte cellulare geneticamente programmato, essenziale per l'omeostasi dei tessuti, che non scatena una risposta infiammatoria.", isFromFile: true },
            { topic: "Danno Cellulare", question: "In caso di patogenesi ischemica il quadro morfologico sarà generalmente caratterizzato da:", options: ["Necrosi coagulativa", "Necrosi colliquativa", "Necrosi fibrinoide", "Necrosi caseosa", "Apoptosi"], correctAnswer: 0, explanation: "L'ischemia causa una denaturazione delle proteine strutturali ed enzimatiche, ma l'architettura tissutale viene preservata per alcuni giorni. Questo tipo di necrosi è definito coagulativa.", isFromFile: true },
            { topic: "Adattamenti Cellulari", question: "L'aumento del numero delle cellule in un organo o in un tessuto si definisce:", options: ["Iperplasia", "Ipertrofia", "Displasia", "Metaplasia", "Neoplasia"], correctAnswer: 0, explanation: "L'iperplasia è un aumento del numero di cellule in un tessuto, che porta a un aumento del volume dell'organo. È diversa dall'ipertrofia, che è un aumento del volume delle singole cellule.", isFromFile: true },
            { topic: "Neoplasie", question: "Il 'grading', o graduazione, di una neoplasia?", options: ["Esprime il grado di differenziazione di una neoplasia maligna", "Definisce la benignità o la malignità", "Definisce l'estensione di una neoplasia", "Esprime la localizzazione", "È un parametro trascurabile"], correctAnswer: 0, explanation: "Il grading istologico valuta il grado di somiglianza delle cellule tumorali con il tessuto di origine (differenziazione). Un tumore ben differenziato (basso grado) assomiglia molto al tessuto normale, mentre uno scarsamente differenziato (alto grado) se ne discosta notevolmente.", isFromFile: true },
            { topic: "Neoplasie", question: "Nell'ambito del sistema di stadiazione TNM il parametro M esprime:", options: ["L'estensione del tumore rispetto l'organismo in toto", "Il coinvolgimento dei linfonodi loco-regionali", "La presenza di metastasi a distanza", "Il coinvolgimento di linfonodi a distanza", "L'estensione del tumore rispetto l'organo di origine"], correctAnswer: 2, explanation: "Il sistema TNM è il sistema di stadiazione più usato. T descrive il tumore primitivo, N lo stato dei linfonodi regionali, e M la presenza (M1) o assenza (M0) di metastasi a distanza.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Un paziente ha un dolore anginoso per trombosi di una coronaria epicardica. Viene effettuata trombolisi entro 25 minuti dall’insorgenza del dolore. Quale conseguenza si può attendere per l'area miocardica ischemica?", options: ["Rottura di cuore ed emopericardio", "Salvataggio del miocardio che però rimane stordito", "Sviluppo di infarto ischemico, che rimane limitato al terzo subendocardico", "Sviluppo di infarto ischemico transmurale", "Sviluppo di infarto emorragico da rivascolarizzazione"], correctAnswer: 1, explanation: "Una riperfusione molto precoce (entro 20-40 minuti) può salvare il miocardio dalla necrosi. Tuttavia, il tessuto salvato può rimanere 'stordito', con una disfunzione contrattile transitoria che si risolve in ore o giorni.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Quale delle seguenti condizioni NON è una possibile complicanza dell'infarto del miocardio?", options: ["Rottura del cuore e tamponamento cardiaco", "Perforazione del setto interventricolare", "Trombosi endocardiaca", "Pericardite di Dressler", "Insufficienza acuta della valvola aortica"], correctAnswer: 4, explanation: "L'insufficienza aortica acuta non è una complicanza diretta dell'IMA. Le complicanze meccaniche includono la rottura di parete, setto o muscolo papillare (che causa insufficienza mitralica, non aortica).", isFromFile: true },
            { topic: "Polmone-Respiratorio", question: "Quale tra le seguenti NON è una pneumoconiosi:", options: ["Asbestosi", "Silicosi", "Aspergillosi", "Antracosi", "Berilliosi"], correctAnswer: 2, explanation: "Le pneumoconiosi sono malattie polmonari causate dall'inalazione di polveri inorganiche. L'aspergillosi è invece un'infezione causata da un fungo del genere Aspergillus.", isFromFile: true },
            { topic: "Polmone-Respiratorio", question: "Il mesotelioma:", options: ["È un tumore primitivo periferico del polmone", "Riconosce l’esposizione dell’asbesto come fattore di rischio", "È sinonimo di carcinomatosi pleurica", "Colpisce esclusivamente la sierosa pleurica", "Nessuna delle risposte indicate"], correctAnswer: 1, explanation: "Il mesotelioma è un tumore maligno che origina dalle cellule mesoteliali delle sierose (pleura, peritoneo, pericardio). La sua associazione con l'esposizione a fibre di asbesto è molto forte e ben documentata.", isFromFile: true },
            { topic: "Osso", question: "La complicanza più grave dell’osteoporosi è:", options: ["Il gibbo acuto", "La sostituzione adiposa del midollo", "I dolori diffusi", "Il gibbo armonico", "La frattura del collo del femore nell’anziano"], correctAnswer: 4, explanation: "L'osteoporosi è una riduzione della massa ossea che aumenta la fragilità dello scheletro. La sua complicanza più grave e comune, specialmente nella popolazione anziana, è la frattura patologica, tipicamente a carico del collo del femore, delle vertebre o del polso.", isFromFile: true },
            { topic: "Mammella", question: "Il carcinoma lobulare infiltrante della mammella:", options: ["Insorge nei lobuli", "Non è mai multicentrico", "Metastatizza tardivamente", "Ha una buona prognosi", "Infiltra a “fila indiana”"], correctAnswer: 4, explanation: "A causa della perdita di espressione della E-caderina, le cellule del carcinoma lobulare infiltrante perdono coesione e tipicamente infiltrano lo stroma in singole file, un pattern detto 'a fila indiana'.", isFromFile: true },
            { topic: "Rene, Vie Urinarie e Vescica", question: "Caratteristica costante della sindrome nefrosica è?", options: ["Oliguria", "Poliuria", "Ematuria", "Proteinuria", "Glicosuria"], correctAnswer: 3, explanation: "La sindrome nefrosica è definita da una proteinuria massiva (>3.5 g/24h), che causa ipoalbuminemia, edema e iperlipidemia. La proteinuria è il segno cardinale.", isFromFile: true },
            { topic: "Testicolo", question: "Un tumore testicolare a differenziazione cito e sinciziotrofoblastica viene definito:", options: ["Seminoma", "Teratoma", "Carcinoma embrionale", "Coriocarcinoma", "Tumore del sacco vitellino"], correctAnswer: 3, explanation: "Il coriocarcinoma è composto da elementi che mimano il trofoblasto placentare: il citotrofoblasto (cellule mononucleate) e il sinciziotrofoblasto (cellule multinucleate giganti), queste ultime responsabili della produzione di β-hCG.", isFromFile: true },
            { topic: "Prostata", question: "Nell’adenocarcinoma della prostata:", options: ["Le ghiandole sono circondate da cellule basali", "Le cellule neoplastiche presentano nucleolo evidente", "È sempre presente necrosi comedonica", "Le cellule sono sempre chiare", "Non si usa il grading di Gleason"], correctAnswer: 1, explanation: "Una delle caratteristiche istologiche chiave per la diagnosi di adenocarcinoma prostatico è la presenza di nucleoli prominenti, specialmente nei gradi più alti. L'assenza dello strato di cellule basali è un altro criterio fondamentale.", isFromFile: true },
            { topic: "Ovaio e Utero", question: "Una donna di 55 anni presenta distensione addominale progressiva negli ultimi 5 mesi. Un'ecografia pelvica mostra masse cistiche ovariche bilaterali di 7 e 10 cm con proiezioni papillari. L’esame istologico mostra che le papille sono ricoperte da cellule cuboidi atipiche che invadono lo stroma sottostante, sono presenti alcuni corpi psammomatosi. Qual è la diagnosi più probabile?", options: ["Tumore a cellule della granulosa", "Teratoma maturo cistico", "Tumore endometrioide", "Disgerminoma", "Cistoadenocarcinoma sieroso"], correctAnswer: 4, explanation: "La descrizione (bilaterale, cistico con proiezioni papillari, invasione stromale e corpi psammomatosi) è classica per un cistoadenocarcinoma sieroso di alto grado, il tumore maligno più comune dell'ovaio.", isFromFile: true },
            { topic: "Metodologia", question: "Quale dei seguenti parametri non è apprezzabile su un esame istologico in microscopia ottica?", options: ["Caratteristiche nucleari", "Architettura del tessuto", "Caratteristiche citoplasmatiche", "Inclusi nucleari e citoplasmatici", "Densità dei mitocondri"], correctAnswer: 4, explanation: "La densità e la morfologia fine degli organelli come i mitocondri richiedono l'ultrisoluzione del microscopio elettronico e non sono apprezzabili con la microscopia ottica standard.", isFromFile: true },
            { topic: "Danno Cellulare", question: "Cosa distingue istologicamente la necrosi coagulativa dalla necrosi colliquativa:", options: ["L'eosinofilia del citoplasma", "La picnosi del nucleo", "La possibilità o meno di conoscere la forma delle cellule necrotiche", "La diversa colorabilità con il metodo PAS", "Presenza / assenza di infiltrato infiammatorio"], correctAnswer: 2, explanation: "Nella necrosi coagulativa, la forma delle cellule morte viene mantenuta per un certo tempo. Nella necrosi colliquativa, la digestione enzimatica del tessuto è rapida e completa, portando alla perdita dell'architettura e alla formazione di una massa liquida viscosa.", isFromFile: true },
            { topic: "Adattamenti Cellulari", question: "Per metaplasia si intende:", options: ["La trasformazione di un tessuto in un altro", "La trasformazione di un tessuto ben differenziato in un altro ben differenziato", "La trasformazione di un tessuto ben differenziato in un altro ben differenziato della stessa derivazione istologica", "Un evento preneoplastico", "Una neoplasia in situ"], correctAnswer: 2, explanation: "La metaplasia è la sostituzione reversibile di un tipo cellulare adulto (epiteliale o mesenchimale) con un altro tipo cellulare adulto, solitamente come adattamento a uno stress cronico. La derivazione embriologica deve essere la stessa.", isFromFile: true },
            { topic: "Neoplasie", question: "Lo 'staging', stadiazione, di una neoplasia:", options: ["Esprime il grado di differenziazione", "Definisce la benignità o la malignità", "Definisce l'estensione di una neoplasia maligna rispetto l'organismo", "Esprime la localizzazione superficiale o profonda", "È un parametro trascurabile"], correctAnswer: 2, explanation: "Lo staging descrive l'estensione anatomica del tumore (dimensioni, invasione locale, coinvolgimento linfonodale, metastasi a distanza). È il fattore prognostico più importante per la maggior parte dei tumori.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Quale, tra i seguenti, non è un fattore di rischio per l’aterosclerosi:", options: ["Alti livelli ematici di HDL", "Diabete", "Ipertensione arteriosa", "Fumo di sigaretta", "Carenza di esercizio fisico"], correctAnswer: 0, explanation: "Le lipoproteine ad alta densità (HDL) hanno un ruolo protettivo contro l'aterosclerosi, promuovendo il trasporto inverso del colesterolo dai tessuti periferici al fegato. Alti livelli di HDL sono quindi desiderabili.", isFromFile: true },
            { topic: "Polmone-Respiratorio", question: "Quale/i istotipi di carcinoma del polmone sono più frequentemente periferici?", options: ["Carcinoma epidermoide e Microcitoma", "Adenocarcinoma e Adenocarcinoma bronchioloalveolare", "Solo Microcitoma", "Tutti tranne l'Adenocarcinoma", "Solo Adenolinfoma"], correctAnswer: 1, explanation: "Mentre i carcinomi squamosi e a piccole cellule tendono a essere centrali (ilari), l'adenocarcinoma (l'istotipo oggi più frequente) insorge tipicamente in sede periferica.", isFromFile: true },
            { topic: "Osso", question: "La condizione neoplastica maligna più frequente dell'osso:", options: ["Il condrosarcoma", "L’osteosarcoma", "La malattia metastatica", "Il mieloma multiplo", "Il sarcoma di Ewing"], correctAnswer: 2, explanation: "Le metastasi da altri tumori (es. mammella, prostata, polmone, rene) sono le neoplasie maligne più comuni che si riscontrano nello scheletro, superando di gran lunga i tumori ossei primitivi.", isFromFile: true },
            { topic: "Mammella", question: "Quale dei seguenti istotipi di carcinoma infiltrante della mammella ha la prognosi migliore:", options: ["Carcinoma duttale tipo NAS", "Carcinoma lobulare", "Carcinoma midollare con stroma linfoide", "Carcinoma mucinoso", "Carcinoma neuroendocrino"], correctAnswer: 2, explanation: "Il carcinoma midollare, sebbene spesso triplo negativo, è caratterizzato da un cospicuo infiltrato linfocitario e ha una prognosi relativamente favorevole rispetto ad altri carcinomi di alto grado. Anche il mucinoso e il tubulare (non in lista) hanno buona prognosi.", isFromFile: true },
            { topic: "Rene, Vie Urinarie e Vescica", question: "La glomerulonefrite rapidamente progressiva è caratterizzata istologicamente da:", options: ["Proliferazione delle cellule endoteliali", "Proliferazione delle cellule mesangiali", "Formazione di semilune nello spazio di filtrazione renale", "Ialinizzazioni focali delle anse glomerulari", "Formazioni di anse a fil di ferro"], correctAnswer: 2, explanation: "La caratteristica istologica distintiva della GNRP è la formazione di 'semilune' (crescents) nello spazio di Bowman, dovute alla proliferazione delle cellule epiteliali parietali e all'infiltrazione di monociti/macrofagi.", isFromFile: true },
            { topic: "Testicolo", question: "Quale tra le seguenti affermazioni sul seminoma è/sono esatta/e? I. È una neoplasia neuroendocrina II. Metastatizza ai linfonodi paraortici III. È il più maligno dei tumori del testicolo IV. È spesso caratterizzato da infiltrato linfocitario V. Presenta un aspetto adenoideo", options: ["IV, V", "V", "II, IV", "IV", "I, II, III"], correctAnswer: 2, explanation: "Il seminoma metastatizza tipicamente per via linfatica ai linfonodi paraortici (drenaggio primario del testicolo) e istologicamente presenta spesso un caratteristico infiltrato linfocitario stromale. Non è neuroendocrino e non è il più maligno (il coriocarcinoma lo è).", isFromFile: true },
            { topic: "Prostata", question: "Il Grade Group dell’adenocarcinoma prostatico viene attribuito:", options: ["Sui valori di PSA", "Sommando pattern primario, secondario e terziario", "Sul pattern prevalente di Gleason", "Sul grado combinato di Gleason", "Nessuna delle risposte indicate"], correctAnswer: 3, explanation: "Il sistema Grade Group (da 1 a 5) è una semplificazione prognostica del Gleason Score. Si basa sulla somma dei due pattern di Gleason più rappresentati nel tumore (es. Gleason 3+4 = 7, che corrisponde al Grade Group 2).", isFromFile: true },
            { topic: "Ovaio e Utero", question: "Una donna di 69 anni ha avuto sanguinamenti vaginali per un mese, l’esame pelvico non mostra anomalie di rilievo. A che procedura dovremmo ricorrere?", options: ["Biopsia endometriale", "Test di gravidanza", "Esame microbiologico", "Risonanza magnetica", "PAP test"], correctAnswer: 0, explanation: "Un sanguinamento in post-menopausa richiede sempre un'indagine per escludere un carcinoma dell'endometrio. La procedura diagnostica di scelta è la biopsia endometriale, spesso eseguita tramite isteroscopia.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Quale tratto coronarico è verosimilmente occluso in un paziente con infarto dei due terzi anteriori del setto interventricolare e della faccia anteriore del ventricolo sinistro?", options: ["Ramo discendente anteriore a monte dell'emergenza del primo ramo diagonale", "Ramo discendente anteriore a valle dell'emergenza del primo ramo diagonale", "Tronco comune della coronaria destra", "Tronco comune della coronaria sinistra", "Ramo circonflesso"], correctAnswer: 0, explanation: "L'arteria discendente anteriore (IVA) irrora la parete anteriore del ventricolo sinistro e i 2/3 anteriori del setto. Un'occlusione a monte del primo ramo diagonale causa un infarto molto esteso in questo territorio.", isFromFile: true },
            { topic: "Polmone-Respiratorio", question: "Quale/i delle seguenti affermazioni sono esatte? I. L’enfisema centro-acinare è il piu frequente II. L’enfisema pan-acinare è associato alla deficienza di alpha1-antitripsina III. L’iperinsufflazione è una forma di enfisema molto grave IV. Le aree enfisematose sono aumentate di consistenza V. L’enfisema parasettale colpisce le zone vicine ai setti fibrosi", options: ["Tutte", "Nessuna", "I, II, III", "I, II, V", "I, III, V"], correctAnswer: 3, explanation: "L'enfisema centro-acinare è il più comune (fumo), il pan-acinare è legato al deficit di A1AT e il parasettale è adiacente alla pleura/setti. L'iperinsufflazione non è un tipo di enfisema e le aree enfisematose hanno consistenza diminuita.", isFromFile: true },
            { topic: "Osso", question: "Nel sarcoma di Ewing NON:", options: ["È chemiosensibile", "È radiosensibile", "Colpisce i giovani", "Produce osso e/o cartilagine", "Si accompagna a sintomi generali"], correctAnswer: 3, explanation: "Il sarcoma di Ewing è un tumore a piccole cellule rotonde che non produce matrice ossea o cartilaginea, a differenza dell'osteosarcoma o del condrosarcoma. Questa caratteristica è fondamentale per la diagnosi differenziale.", isFromFile: true },
            { topic: "Mammella", question: "La malattia di Paget della mammella è:", options: ["Un carcinoma", "Una mastite", "Un adenoma", "Una disfunzione endocrina", "Un sarcoma"], correctAnswer: 0, explanation: "La malattia di Paget del capezzolo è una manifestazione di un carcinoma duttale (solitamente in situ) sottostante, le cui cellule migrano lungo i dotti galattofori fino a infiltrare l'epidermide del capezzolo, causando una lesione eczematosa.", isFromFile: true },
            { topic: "Rene, Vie Urinarie e Vescica", question: "Il tumore della pelvi renale più frequente è:", options: ["Il carcinoma uroteliale", "L’adenocarcinoma", "Il carcinoma a cellule renali", "Il carcinoma epidermoide", "Il carcinoma a piccole cellule"], correctAnswer: 0, explanation: "La pelvi renale è rivestita da urotelio, lo stesso epitelio della vescica. Pertanto, il tumore più comune in questa sede è il carcinoma uroteliale (o a cellule transizionali).", isFromFile: true },
            { topic: "Testicolo", question: "Un uomo di 24 anni accusa una tumefazione testicolare indolente, ecograficamente di aspetto disomogeneo. Qual/Quali è/sono la/le diagnosi più probabili?", options: ["Atrofia, Torsione, Idrocele", "Neoplasia testicolare", "Idrocele, Neoplasia, Orchite", "Tutte", "Solo Idrocele e Orchite"], correctAnswer: 1, explanation: "Una massa testicolare solida, indolente, in un giovane uomo deve essere considerata una neoplasia maligna fino a prova contraria. È la presentazione clinica più tipica dei tumori a cellule germinali.", isFromFile: true },
            { topic: "Prostata", question: "Quale delle seguenti informazioni circa l’iperplasia prostatica non è esatta?", options: ["Origina dalla porzione periuretrale", "Istologicamente è evidente iperplasia delle ghiandole e dello stroma", "Interessa il 90% dei maschi superiori ai 70 anni", "È un fattore di rischio per lo sviluppo del carcinoma della prostata", "La componente ghiandolare presenta il doppio strato di cellule"], correctAnswer: 3, explanation: "L'iperplasia prostatica benigna (IPB) non è considerata una lesione pre-cancerosa e non aumenta il rischio di sviluppare un adenocarcinoma prostatico, che tipicamente origina in una zona diversa (periferica).", isFromFile: true },
            { topic: "Ovaio e Utero", question: "Quale dei seguenti è un tumore dell’ovaio che non si presenta mai in forma cistica:", options: ["Cistoadenocarcinoma sieroso", "Tumore di Brenner", "Tumore di Krukenberg", "Teratoma maturo", "Tumore mucinoso"], correctAnswer: 2, explanation: "Il tumore di Krukenberg è una metastasi ovarica, tipicamente da un adenocarcinoma gastrico a cellule con castone. È caratteristicamente solido, a differenza di molti tumori ovarici primari che sono cistici.", isFromFile: true },
            { topic: "Metodologia", question: "Quale delle seguenti affermazioni è esatta:", options: ["Una sostanza acida è generalmente basofila e quindi ematossilinofila", "Una sostanza acida è generalmente acidofila e quindi ematossilinofila", "Una sostanza acida è generalmente basofila e quindi eosinofila", "Una sostanza acida è generalmente acidofila e quindi eosinofila", "Una sostanza acida è anfofila"], correctAnswer: 0, explanation: "Le sostanze acide (come gli acidi nucleici) hanno affinità per i coloranti basici. L'ematossilina è un colorante basico, quindi le strutture acide sono basofile ed ematossilinofile.", isFromFile: true },
            { topic: "Danno Cellulare", question: "In caso di infezione tubercolare il quadro morfologico sarà generalmente caratterizzato da:", options: ["Necrosi coagulativa", "Necrosi colliquativa", "Necrosi fibrinoide", "Necrosi caseosa", "Apoptosi"], correctAnswer: 3, explanation: "La necrosi caseosa è la forma di necrosi patognomonica della tubercolosi. Macroscopicamente appare come materiale biancastro, friabile, simile a formaggio ('caseus' in latino).", isFromFile: true },
            { topic: "Adattamenti Cellulari", question: "Non è una causa di atrofia:", options: ["Disuso", "Denervazione", "Aumentato stimolo endocrino", "Malnutrizione", "Diminuito apporto ematico"], correctAnswer: 2, explanation: "Un aumentato stimolo endocrino causa iperplasia o ipertrofia del tessuto bersaglio, non atrofia. L'atrofia è una riduzione delle dimensioni cellulari dovuta a una ridotta richiesta funzionale o a condizioni avverse.", isFromFile: true },
            { topic: "Neoplasie", question: "Per anaplasia si intende?", options: ["Una forma di iperplasia patologica", "Un tipo di neoplasia a prognosi infausta", "Una forma particolare di metaplasia", "Una forma grave di displasia", "La mancanza di differenziazione delle cellule neoplastiche"], correctAnswer: 4, explanation: "L'anaplasia rappresenta la perdita completa della differenziazione cellulare ed è un segno distintivo di malignità. Le cellule anaplastiche sono pleomorfe, con nuclei bizzarri e ipercromatici.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "La cardiomiopatia aritmogena del ventricolo destro: I geni più frequentemente coinvolti codificano per:", options: ["Proteine del sarcomero", "Proteine mitocondriali", "Proteine del desmosoma", "Canali del potassio", "Recettori adrenergici"], correctAnswer: 2, explanation: "La cardiomiopatia aritmogena è una 'malattia del desmosoma', causata da mutazioni in geni che codificano per proteine desmosomiali (placoglobina, desmoplachina, etc.), che porta a distacco dei miociti e sostituzione fibroadiposa.", isFromFile: true },
            { topic: "Polmone-Respiratorio", question: "Un uomo di 78 anni mostra dispnea ingravescente e una massa pleurica che incarcera il polmone. La biopsia mostra cellule fusate e cuboidi. Quale particella è verosimilmente responsabile?", options: ["Silice", "Particelle di carbone", "Asbesto", "Fibre di cotone", "Berillio"], correctAnswer: 2, explanation: "La descrizione di una massa pleurica diffusa in un paziente anziano, con istologia bifasica (cellule epitelioidi/cuboidi e fusate/sarcomatoidi), è classica per un mesotelioma maligno, fortemente associato all'esposizione ad asbesto.", isFromFile: true },
            { topic: "Osso", question: "L’osteosarcoma è:", options: ["Un tumore benigno dell'osso", "Una malattia metabolica simil-neoplastica", "Un tumore maligno dell'osso", "Un tumore maligno del midollo", "Un tumore benigno del midollo"], correctAnswer: 2, explanation: "L'osteosarcoma è il tumore maligno primitivo più comune dell'osso (escludendo il mieloma), caratterizzato dalla produzione di matrice osteoide o osso immaturo da parte delle cellule neoplastiche.", isFromFile: true },
            { topic: "Mammella", question: "Una donna di 24 anni in fase pre-ovulare avverte un nodulo dolente, tondeggiante, a superficie liscia e mobile. Qual è l’ipotesi diagnostica più probabile?", options: ["Fibroadenoma", "Carcinoma in situ", "Carcinoma infiltrante", "Tumore filloide", "Modificazioni fibroso-cistiche"], correctAnswer: 0, explanation: "Un nodulo mobile, ben definito, in una donna giovane è altamente suggestivo di un fibroadenoma, il tumore benigno più comune in questa fascia d'età. Le modificazioni fibrocistiche sono più spesso mal definite e multiple.", isFromFile: true },
            // --- NUOVE DOMANDE AGGIUNTE ---
            { topic: "Cardiocircolatorio", question: "Un paziente muore per gli esiti di un infarto del miocardio e i familiari denunciano i sanitari perché ritengono che questi siano intervenuti tardivamente. Il patologo riceve dei preparati nei quali è presente un infiltrato interstiziale di granulociti neutrofili e alla periferia del focolaio infartuale sono presenti macrofagi, fibroblasti e capillari neoformati. A quando fate risalire l'infarto?", options: ["12-24h prima", "24-36h prima", "3-5 giorni prima", "2-4 settimane prima", "7-10 giorni prima"], correctAnswer: 2, explanation: "La presenza simultanea di un infiltrato di granulociti neutrofili (picco a 1-3 giorni) e l'inizio della formazione di tessuto di granulazione (macrofagi, fibroblasti, capillari, che inizia dopo il 3° giorno) permette di datare l'infarto a circa 3-5 giorni prima del decesso.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Quale tra i seguenti non è un carattere morfologico della cardiomiopatia dilatativa:", options: ["Presenza di fibre muscolari striate", "Fibrosi focale dell’endocardio del ventricolo sinistro", "Ipertrofia eccentrica del miocardio", "Disarray delle miocellule", "Insufficienza relativa della valvola mitrale"], correctAnswer: 3, explanation: "Il 'disarray' (disorganizzazione) delle miocellule è la caratteristica istologica distintiva della cardiomiopatia ipertrofica, non di quella dilatativa. La cardiomiopatia dilatativa è caratterizzata da ipertrofia eccentrica, fibrosi e dilatazione ventricolare.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Un cuore pesa 700 grammi ed ha forma globosa. Al taglio si osserva una dilatazione moderata delle cavità atriali, con dilatazione dell'anello delle valvole atrioventricolari. Il ventricolo sinistro è notevolmente aumentato di volume, con spessore parietale conservato. Che diagnosi fai?", options: ["Cardiopatia ipertensiva", "Cardiomiopatia dilatativa", "Cardiopatia ischemica cronica", "Endocardite reumatica", "Cardiomiopatia ipertrofica"], correctAnswer: 1, explanation: "Il quadro macroscopico descritto (cuore globoso, aumentato di peso, con dilatazione ventricolare sinistra, fibrosi sostitutiva e trombo apicale) è classico della cardiomiopatia dilatativa.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Quale, tra le seguenti popolazioni cellulari, NON è presente nella placca fibroateromasica?", options: ["Macrofagi schiumosi miogenici", "Macrofagi schiumosi monocitogenici", "Fibrocellule muscolari lisce", "Linfociti T", "Cellule adipose"], correctAnswer: 4, explanation: "La placca ateromasica è composta da cellule muscolari lisce, macrofagi (anche schiumosi), linfociti T e matrice extracellulare. Le cellule adipose non sono un componente tipico della placca stessa.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Una paziente di 45 anni è affetta da numerosi anni da stenosi mitralica serrata. La valvola viene rimossa e sostituita. I lembi risultano ispessiti, duri, con commessure fuse e corde tendinee accorciate. Quale diagnosi fate?", options: ["Endocardite infettiva", "Endocardite da artrite reumatoide", "Calcificazione distrofica", "Endocardite trombotica", "Endocardite fibroblastica di verosimile origine reumatica"], correctAnswer: 4, explanation: "L'ispessimento e fusione dei lembi valvolari e delle corde tendinee, con calcificazioni, è il quadro tipico degli esiti cronici di una endocardite reumatica, che porta a stenosi mitralica.", isFromFile: true },
            { topic: "Gastrointestinale", question: "L'istotipo più frequente di carcinoma dell'esofago è:", options: ["Carcinoma malpighiano", "Adenocarcinoma", "Carcinoma adenosquamoso", "Carcinoma su esofago di Barrett", "Angiosarcoma"], correctAnswer: 0, explanation: "A livello mondiale, il carcinoma a cellule squamose (o malpighiano) è l'istotipo più frequente di cancro esofageo, sebbene nei paesi occidentali l'incidenza dell'adenocarcinoma (spesso su esofago di Barrett) sia in forte aumento.", isFromFile: true },
            { topic: "Gastrointestinale", question: "La neoplasia epatica più frequente è:", options: ["Epatocarcinoma", "Colangiocarcinoma", "Epatoblastoma", "Angioma", "Carcinoma metastatico"], correctAnswer: 4, explanation: "Le metastasi da altri tumori (colon-retto, polmone, mammella, etc.) sono le neoplasie maligne più comuni riscontrate nel fegato, superando di gran lunga i tumori epatici primitivi come l'epatocarcinoma.", isFromFile: true },
            { topic: "Gastrointestinale", question: "L'early gastric cancer…", options: ["È limitato alla mucosa e alla sottomucosa", "Non supera la membrana basale", "Non metastatizza mai", "Colpisce gli adolescenti", "È esclusivo dei giapponesi"], correctAnswer: 0, explanation: "Per definizione, l'Early Gastric Cancer è un carcinoma che infiltra la mucosa e/o la sottomucosa, indipendentemente dallo stato dei linfonodi. Questa stadiazione precoce ha una prognosi eccellente dopo resezione.", isFromFile: true },
            { topic: "Gastrointestinale", question: "Non è una caratteristica istologica del Morbo di Crohn:", options: ["Presenza di granulomi", "Interessamento a tutto spessore della parete", "Presenza frequente di displasia", "Presenza di infiltrato linfocitario", "Presenza di ulcerazioni aftoidi"], correctAnswer: 2, explanation: "La displasia può insorgere come complicanza a lungo termine del Crohn, ma non è una caratteristica istologica tipica della malattia attiva, che è invece caratterizzata da infiammazione transmurale, ulcere aftoidi e granulomi non caseosi.", isFromFile: true },
            { topic: "Gastrointestinale", question: "Un soggetto con esofago di Barrett:", options: ["Non ha alcun problema clinico", "Rischia esclusivamente esofagiti ricorrenti", "Ha un aumentato rischio di sviluppare carcinoma malpighiano dell'esofago", "Ha un aumentato rischio di sviluppare adenocarcinoma dell'esofago", "È protetto dal carcinoma esofageo"], correctAnswer: 3, explanation: "L'esofago di Barrett è una metaplasia intestinale dell'epitelio esofageo distale ed è il principale fattore di rischio per lo sviluppo dell'adenocarcinoma esofageo.", isFromFile: true },
            { topic: "Gastrointestinale", question: "Quale dei seguenti polipi non è a rischio di trasformazione maligna?", options: ["Adenocarcinoma polipoide", "Polipo amartomatoso", "Adenoma tubulare", "Adenoma villoso", "Adenoma tubulo-villoso"], correctAnswer: 1, explanation: "I polipi amartomatosi (es. Peutz-Jeghers) sono malformazioni tissutali e hanno un rischio di trasformazione maligna intrinseca molto basso, a differenza degli adenomi (tubulari, villosi) che sono lesioni pre-neoplastiche.", isFromFile: true },
            { topic: "Polmone-Respiratorio", question: "Un uomo di 78 anni presenta dispnea ingravescente e una massa pleurica che incarcera il polmone. La biopsia mostra cellule fusate e cuboidi. Quale particella è verosimilmente responsabile?", options: ["Silice", "Particelle di carbone", "Asbesto", "Fibre di cotone", "Berillio"], correctAnswer: 2, explanation: "La descrizione di una massa pleurica diffusa in un paziente anziano, con istologia bifasica (cellule epitelioidi/cuboidi e fusate/sarcomatoidi), è classica per un mesotelioma maligno, fortemente associato all'esposizione ad asbesto.", isFromFile: true },
            { topic: "Osso", question: "Nell’osteoporosi si può avere:", options: ["Ipercalcificazione cartilagine", "Normale e/o aumentata deposizione di matrice ossea, ma normale calcificazione", "Diminuita deposizione di matrice ossea, ma normale calcificazione", "Diminuita deposizione di matrice ossea e diminuita calcificazione", "Normale e/o aumentata deposizione di matrice ossea, ma diminuita calcificazione"], correctAnswer: 2, explanation: "L'osteoporosi è caratterizzata da una perdita di massa ossea, cioè una ridotta quantità di matrice ossea (osteopenia), ma la matrice residua è normalmente mineralizzata (calcificata).", isFromFile: true },
            { topic: "Mammella", question: "Non è un fattore di rischio per il carcinoma della mammella:", options: ["Nulliparità", "Menarca precoce", "Obesità", "Promiscuità sessuale", "Cicli anovulatori"], correctAnswer: 3, explanation: "I principali fattori di rischio per il carcinoma mammario sono legati all'esposizione agli estrogeni (menarca precoce, nulliparità, obesità). La promiscuità sessuale non è un fattore di rischio diretto per il tumore al seno.", isFromFile: true },
            { topic: "Rene, Vie Urinarie e Vescica", question: "NON è un fattore di rischio per il carcinoma della vescica:", options: ["Attività lavorativa con i coloranti contenenti anilina", "Calcolosi vescicale", "Infestazione da Schistosoma", "Fumo di sigaretta", "Promiscuità sessuale"], correctAnswer: 4, explanation: "Il fumo di sigaretta, l'esposizione a amine aromatiche (coloranti), l'infiammazione cronica (calcoli, Schistosoma) sono noti fattori di rischio per il carcinoma uroteliale. La promiscuità sessuale non è direttamente correlata.", isFromFile: true },
            { topic: "Testicolo", question: "Un uomo di 30 anni nota un progressivo ingrossamento dello scroto. Gli esami mostrano un marcato incremento di hCG e alfa-fetoproteina. Qual è la neoplasia più probabile?", options: ["Tumore a cellule di Leydig", "Seminoma spermatocitico", "Tumore germinale misto", "Linfoma a grandi cellule B diffuso", "Coriocarcinoma"], correctAnswer: 2, explanation: "L'aumento contemporaneo di β-hCG e AFP è tipico di un tumore a cellule germinali non seminomatoso, in particolare di un tumore misto, che spesso contiene componenti di coriocarcinoma (produce hCG) e di tumore del sacco vitellino (produce AFP).", isFromFile: true },
            { topic: "Ovaio e Utero", question: "Una donna di 42 anni esegue un Pap test che risulta HSIL con positività per HPV 18. Perché si procede con una conizzazione?", options: ["Presenza di cervicite cronica", "L’infezione da HPV non può essere trattata", "Rischio di carcinoma invasivo", "Fine dell’età riproduttiva", "Stato perimenopausale"], correctAnswer: 2, explanation: "Una lesione HSIL (CIN2/CIN3) ha un rischio significativo di progressione a carcinoma invasivo. La conizzazione è una procedura sia diagnostica che terapeutica per rimuovere la lesione e prevenire l'invasione.", isFromFile: true },
            { topic: "Prostata", question: "Un uomo di 70 anni ha un PSA di 17 ng/ml, il doppio dell'anno prima. Quale sarà il reperto più probabile alla biopsia?", options: ["Prostatite acuta", "Iperplasia benigna", "Neoplasia intraepiteliale prostatica di alto grado", "Prostatite cronica non batterica", "Adenocarcinoma"], correctAnswer: 4, explanation: "Un valore di PSA elevato e in rapido aumento in un uomo anziano è altamente sospetto per un adenocarcinoma prostatico, che richiede una conferma bioptica.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Quale delle seguenti condizioni può predisporre ad un’endocardite infettiva?", options: ["Tutte le condizioni elencate", "Un prolasso della mitrale", "Un ostio aortico bicuspide", "Un impianto di protesi valvolare", "Un'endocardite reumatica"], correctAnswer: 0, explanation: "Tutte le condizioni elencate (prolasso mitrale, valvola bicuspide, protesi valvolari, esiti di endocardite reumatica) creano turbolenze del flusso sanguigno e/o superfici anomale che favoriscono l'adesione batterica e lo sviluppo di un'endocardite infettiva.", isFromFile: true },
            { topic: "Cardiocircolatorio", question: "Abbina placca stabile (I) e instabile (II) con le caratteristiche: A-stenosi eccentrica, B-stenosi concentrica, C-ampio ateroma/cappuccio sottile, D-placca fibrocalcifica, E-infiltrato infiammatorio.", options: ["I BD, II ACE", "I BDE, II AC", "I BC, II ADE", "I ADE, II BC", "I AD, II BCE"], correctAnswer: 0, explanation: "La placca stabile (I) è caratterizzata da stenosi concentrica (B) e fibrosi/calcificazione (D). La placca instabile (II), più a rischio di rottura, presenta tipicamente stenosi eccentrica (A), un ampio core lipidico con cappuccio sottile (C) e un marcato infiltrato infiammatorio (E).", isFromFile: true }
        ];

        // --- GESTIONE DELLO STATO DEL QUIZ ---
        let currentQuestionIndex = 0;
        let selectedQuestions = [];
        let userAnswers = {};
        const TOTAL_QUESTIONS = 45;

        // --- RIFERIMENTI AGLI ELEMENTI DEL DOM ---
        let startQuizBtn, finishQuizBtn, restartBtn, setupSection, quizSection, reportSection, 
            progressContainer, progressBar, progressText, topicSelection, topicsList, selectAllTopics;

        // --- EVENT LISTENER PRINCIPALE ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- FUNZIONI PRINCIPALI ---

        function initializeApp() {
            // Inizializzazione delle variabili degli elementi del DOM
            startQuizBtn = document.getElementById('start-quiz-btn');
            finishQuizBtn = document.getElementById('finish-quiz-btn');
            restartBtn = document.getElementById('restart-btn');
            setupSection = document.getElementById('setup-section');
            quizSection = document.getElementById('quiz-section');
            reportSection = document.getElementById('report-section');
            progressContainer = document.getElementById('progress-container');
            progressBar = document.getElementById('progress-bar');
            progressText = document.getElementById('progress-text');
            topicSelection = document.getElementById('topic-selection');
            topicsList = document.getElementById('topics-list');
            selectAllTopics = document.getElementById('select-all-topics');
            
            // Collegamento degli event listener
            startQuizBtn.addEventListener('click', startQuiz);
            finishQuizBtn.addEventListener('click', finishQuiz);
            restartBtn.addEventListener('click', () => location.reload());
            selectAllTopics.addEventListener('change', toggleAllTopics);
            document.getElementById('prev-btn').addEventListener('click', showPreviousQuestion);
            document.getElementById('next-btn').addEventListener('click', showNextQuestion);

            // Logica di avvio dell'app
            allTopics = [...new Set(questionBank.map(q => q.topic))].sort();
            updateProgressBar(allTopics.length);
            displayTopics();
            startQuizBtn.disabled = false;
        }

        function updateProgressBar(topicsIdentified) {
            progressText.textContent = `Sono stati identificati ${topicsIdentified} argomenti dai tuoi file.`;
            progressContainer.classList.remove('hidden');
        }

        function displayTopics() {
            topicsList.innerHTML = '';
            allTopics.forEach((topic, index) => {
                const topicId = `topic-${index}`;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = topicId;
                checkbox.value = topic;
                checkbox.className = 'topic-checkbox hidden';
                checkbox.checked = true;
                checkbox.addEventListener('change', (e) => {
                    const label = document.querySelector(`label[for=${e.target.id}]`);
                    label.classList.toggle('bg-indigo-600', e.target.checked);
                    label.classList.toggle('text-white', e.target.checked);
                    label.classList.toggle('border-indigo-600', e.target.checked);
                    label.classList.toggle('bg-gray-700', !e.target.checked);
                    label.classList.toggle('text-gray-300', !e.target.checked);
                });

                const label = document.createElement('label');
                label.htmlFor = topicId;
                label.textContent = topic;
                label.className = 'px-3 py-1.5 border border-gray-600 rounded-full text-sm cursor-pointer transition-colors duration-200 bg-indigo-600 text-white border-indigo-600';

                topicsList.appendChild(checkbox);
                topicsList.appendChild(label);
            });
            topicSelection.classList.remove('hidden');
            selectAllTopics.checked = true;
        }
        
        function toggleAllTopics() {
            const checkboxes = document.querySelectorAll('.topic-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked !== selectAllTopics.checked) {
                    checkbox.checked = selectAllTopics.checked;
                    // Trigger change event to update label style
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        }

        function startQuiz() {
            const selectedTopics = Array.from(document.querySelectorAll('.topic-checkbox:checked')).map(cb => cb.value);
            if (selectedTopics.length === 0) {
                const errorMsg = document.createElement('p');
                errorMsg.textContent = 'Per favore, seleziona almeno un argomento.';
                errorMsg.className = 'text-red-400 text-center mt-4';
                startQuizBtn.insertAdjacentElement('afterend', errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
                return;
            }

            // --- NUOVA LOGICA PER EVITARE RIPETIZIONI ---
            // 1. Recupera le domande usate di recente da localStorage
            let recentlyUsedQuestions = JSON.parse(localStorage.getItem('recentlyUsedQuestions')) || [];
            
            // 2. Filtra la banca dati per ottenere solo domande non usate di recente
            let availableQuestions = questionBank.filter(q => !recentlyUsedQuestions.includes(q.question));

            // 3. Se non ci sono abbastanza domande nuove, resetta la lista di quelle usate e riparti
            if (availableQuestions.length < TOTAL_QUESTIONS) {
                console.log("Non ci sono abbastanza domande nuove, resetto la cronologia.");
                recentlyUsedQuestions = [];
                localStorage.removeItem('recentlyUsedQuestions');
                availableQuestions = questionBank;
            }

            // 4. Filtra per argomenti selezionati e mescola
            let filteredByTopic = availableQuestions.filter(q => selectedTopics.includes(q.topic));
             if (filteredByTopic.length < TOTAL_QUESTIONS) {
                // Se anche filtrando per topic non ci sono abbastanza domande, usiamo tutte quelle disponibili (senza filtro topic)
                // per raggiungere il numero, dando priorità a quelle dei topic scelti
                const otherQuestions = availableQuestions.filter(q => !selectedTopics.includes(q.topic));
                filteredByTopic.push(...otherQuestions);
            }
            
            selectedQuestions = filteredByTopic.sort(() => 0.5 - Math.random()).slice(0, TOTAL_QUESTIONS);

            // 5. Aggiorna la lista delle domande usate di recente in localStorage
            const newQuestionsForHistory = selectedQuestions.map(q => q.question);
            recentlyUsedQuestions.push(...newQuestionsForHistory);

            // Mantiene solo le domande degli ultimi 2 quiz (2 * 45 = 90)
            const maxHistorySize = TOTAL_QUESTIONS * 2;
            if (recentlyUsedQuestions.length > maxHistorySize) {
                recentlyUsedQuestions = recentlyUsedQuestions.slice(recentlyUsedQuestions.length - maxHistorySize);
            }
            localStorage.setItem('recentlyUsedQuestions', JSON.stringify(recentlyUsedQuestions));
            // --- FINE NUOVA LOGICA ---

            currentQuestionIndex = 0;
            userAnswers = {};
            
            setupSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            displayCurrentQuestion();
        }

        function displayCurrentQuestion() {
            const quizContent = document.getElementById('quiz-content');
            const q = selectedQuestions[currentQuestionIndex];
            quizContent.innerHTML = '';

            const questionBlock = document.createElement('div');
            const questionText = document.createElement('p');
            questionText.className = 'text-xl font-medium mb-6 text-gray-100';
            const prefix = q.isFromFile ? '[D] ' : '';
            questionText.textContent = `${prefix}${q.question}`;
            questionBlock.appendChild(questionText);

            const optionsList = document.createElement('div');
            optionsList.className = 'space-y-3';
            q.options.forEach((option, optionIndex) => {
                const optionId = `q${currentQuestionIndex}o${optionIndex}`;
                const optionContainer = document.createElement('div');
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.id = optionId;
                radio.name = `question-${currentQuestionIndex}`;
                radio.value = optionIndex;
                radio.className = 'option-radio hidden';
                if (userAnswers[currentQuestionIndex] === optionIndex) {
                    radio.checked = true;
                }
                radio.addEventListener('change', () => {
                    userAnswers[currentQuestionIndex] = parseInt(radio.value);
                });

                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.textContent = option;
                label.className = 'block p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 cursor-pointer transition-colors';
                
                optionContainer.appendChild(radio);
                optionContainer.appendChild(label);
                optionsList.appendChild(optionContainer);
            });
            questionBlock.appendChild(optionsList);
            quizContent.appendChild(questionBlock);

            updateQuizUI();
        }

        function updateQuizUI() {
            document.getElementById('question-counter').textContent = `Domanda ${currentQuestionIndex + 1} di ${TOTAL_QUESTIONS}`;
            const progress = ((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100;
            document.getElementById('quiz-progress-bar').style.width = `${progress}%`;

            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('prev-btn').classList.toggle('opacity-50', currentQuestionIndex === 0);
            
            if (currentQuestionIndex === TOTAL_QUESTIONS - 1) {
                document.getElementById('next-btn').textContent = 'Vedi Risultati';
            } else {
                document.getElementById('next-btn').textContent = 'Successivo';
            }
        }

        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            }
        }

        function showNextQuestion() {
            if (currentQuestionIndex < TOTAL_QUESTIONS - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            let score = 0;
            for (let i = 0; i < selectedQuestions.length; i++) {
                if (userAnswers[i] === selectedQuestions[i].correctAnswer) {
                    score++;
                }
            }
            
            const normalizedScore = Math.round((score / TOTAL_QUESTIONS) * 33);
            document.getElementById('final-score').textContent = `${normalizedScore}/33`;
            
            displayReport();
            quizSection.classList.add('hidden');
            reportSection.classList.remove('hidden');
        }

        function displayReport() {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = '';
            selectedQuestions.forEach((q, index) => {
                const userAnswerIndex = userAnswers[index];
                const isCorrect = userAnswerIndex === q.correctAnswer;
                const wasAnswered = userAnswerIndex !== undefined;

                let cardClass = 'border-gray-600';
                let headerClass = 'bg-gray-700';
                let statusText = 'Non Risposto';
                let statusColor = 'text-gray-400';

                if (wasAnswered) {
                    if (isCorrect) {
                        cardClass = 'border-green-500';
                        headerClass = 'bg-green-900 bg-opacity-50';
                        statusText = 'Corretto';
                        statusColor = 'text-green-400';
                    } else {
                        cardClass = 'border-red-500';
                        headerClass = 'bg-red-900 bg-opacity-50';
                        statusText = 'Sbagliato';
                        statusColor = 'text-red-400';
                    }
                }

                const card = document.createElement('div');
                card.className = `border rounded-lg overflow-hidden ${cardClass}`;

                const header = document.createElement('div');
                header.className = `p-3 cursor-pointer flex justify-between items-center ${headerClass}`;
                const prefix = q.isFromFile ? '[D] ' : '';
                header.innerHTML = `
                    <p class="font-semibold text-gray-200">${index + 1}. ${prefix}${q.question}</p>
                    <div class="flex items-center flex-shrink-0 ml-4">
                        <span class="text-sm font-bold mr-2 ${statusColor}">${statusText}</span>
                        <svg class="w-5 h-5 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                `;

                const body = document.createElement('div');
                body.className = 'p-4 bg-gray-800 border-t border-gray-700 hidden space-y-3';
                
                let bodyHTML = `<p class="text-gray-300"><strong>Risposta corretta:</strong> <span class="text-green-400 font-medium">${q.options[q.correctAnswer]}</span></p>`;
                if (!isCorrect && wasAnswered) {
                    bodyHTML += `<p class="text-gray-300"><strong>La tua risposta:</strong> <span class="text-red-400 font-medium">${q.options[userAnswerIndex]}</span></p>`;
                }
                bodyHTML += `<div class="mt-2 pt-3 border-t border-gray-700"><p class="text-sm text-gray-400"><strong>Spiegazione:</strong> ${q.explanation}</p></div>`;
                body.innerHTML = bodyHTML;

                header.addEventListener('click', () => {
                    body.classList.toggle('hidden');
                    header.querySelector('svg').classList.toggle('rotate-180');
                });

                card.appendChild(header);
                card.appendChild(body);
                reportContent.appendChild(card);
            });
        }
    </script>

</body>
</html>
